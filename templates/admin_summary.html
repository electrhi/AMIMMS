<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š ê´€ë¦¬ì ì¢…í•©ê´€ë¦¬í‘œ</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
  <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">
    ğŸ“Š ì¢…í•©ê´€ë¦¬í‘œ (í´ë¼ì´ì–¸íŠ¸ ë Œë”ë§)
  </h2>

  <div id="table-container" class="overflow-x-auto"></div>

  <div class="flex justify-center mt-8">
    <a href="{{ url_for('menu') }}" 
       class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">â¬… ë©”ë‰´ë¡œ</a>
  </div>
</div>

<script>
async function loadData() {
  const container = document.getElementById("table-container");

  const res = await fetch("/api/admin_data");
  const json = await res.json();

  if (!json.data || json.data.length === 0) {
    container.innerHTML = "<p class='text-center text-red-600 font-semibold mt-4'>âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  const data = json.data;

  // âœ… ê³ ìœ  ì¡°í•© ë° ë°›ëŠ”ì‚¬ëŒ ëª©ë¡ ì¶”ì¶œ
  const comboSet = new Set();
  const receivers = new Set();

  data.forEach(row => {
    comboSet.add(`${row["í†µì‹ ë°©ì‹"]} | ${row["êµ¬ë¶„"]}`);
    receivers.add(row["ë°›ëŠ”ì‚¬ëŒ"]);
  });

  const combos = Array.from(comboSet);
  const receiverList = Array.from(receivers);

  // âœ… í”¼ë²— í…Œì´ë¸” ìƒì„±
  const pivot = {};
  combos.forEach(c => pivot[c] = {});

  data.forEach(row => {
    const key = `${row["í†µì‹ ë°©ì‹"]} | ${row["êµ¬ë¶„"]}`;
    const recv = row["ë°›ëŠ”ì‚¬ëŒ"];
    const qty = Number(row["ìˆ˜ëŸ‰"]) || 0;
    pivot[key][recv] = (pivot[key][recv] || 0) + qty;
  });

  // âœ… í…Œì´ë¸” HTML ìƒì„±
  let html = "<table class='w-full border text-center border-gray-300'>";
  html += "<thead class='bg-blue-100'>";
  html += "<tr><th class='border p-2'>í†µì‹ ë°©ì‹</th><th class='border p-2'>êµ¬ë¶„</th><th class='border p-2'>í•©ê³„</th>";
  receiverList.forEach(r => html += `<th class='border p-2'>${r}</th>`);
  html += "</tr></thead><tbody>";

  combos.forEach(c => {
    const [type, category] = c.split(" | ");

    // âœ… í•©ê³„ ê³„ì‚°
    const total = receiverList.reduce((sum, r) => sum + (pivot[c][r] || 0), 0);

    html += `<tr>
               <td class='border p-2'>${type}</td>
               <td class='border p-2'>${category}</td>
               <td class='border p-2 font-semibold bg-gray-50'>${total}</td>`;
    receiverList.forEach(r => {
      html += `<td class='border p-2'>${pivot[c][r] || ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

window.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
