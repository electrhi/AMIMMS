<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š ê´€ë¦¬ì ì¢…í•©ê´€ë¦¬í‘œ</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- âœ… ìŠ¤íƒ€ì¼ì€ <head> ì•ˆìœ¼ë¡œ ì´ë™ -->
<style>
  /* âœ… í‘œ ìŠ¤íƒ€ì¼ ê°œì„  */
  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 1000px; /* ë„ˆë¬´ ì¢ì•„ì§€ì§€ ì•Šê²Œ ìµœì†Œí­ ì§€ì • */
    table-layout: auto;
    font-size: 0.85rem;  /* ê¸€ì ì•½ê°„ ì¤„ì´ê¸° */
    white-space: nowrap; /* ê¸€ì ì¤„ë°”ê¿ˆ ë°©ì§€ â†’ ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  }

  th, td {
    padding: 6px 10px;
    text-align: center;
    border: 1px solid #ccc;
  }

  thead th {
    position: sticky;   /* âœ… ë¨¸ë¦¬ê¸€ ê³ ì • */
    top: 0;
    background-color: #e8f0fe;
    z-index: 1;
  }

  /* âœ… í–‰ hover íš¨ê³¼ */
  tbody tr:hover {
    background-color: #f9f9f9;
  }

  /* âœ… ê¸´ ì´ë¦„ì¼ ë•Œ ìë™ ì¤„ì´ê¸° */
  td {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
  <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">
    ğŸ“Š ì¢…í•©ê´€ë¦¬í‘œ (í´ë¼ì´ì–¸íŠ¸ ë Œë”ë§)
  </h2>

  <!-- âœ… í‘œ ì»¨í…Œì´ë„ˆ -->
  <div id="table-container" 
       class="overflow-x-auto max-w-full mt-4 border border-gray-200 rounded-lg shadow-inner"></div>

  <div class="flex justify-center mt-8">
    <a href="{{ url_for('menu') }}" 
       class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">â¬… ë©”ë‰´ë¡œ</a>
  </div>
</div>

<script>
async function loadData() {
  const container = document.getElementById("table-container");

  const res = await fetch("/api/admin_data");
  const json = await res.json();

  if (!json.data || json.data.length === 0) {
    container.innerHTML = "<p class='text-center text-red-600 font-semibold mt-4'>âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  const data = json.data;

  // âœ… ê³ ìœ  ì¡°í•© ë° ë°›ëŠ”ì‚¬ëŒ ëª©ë¡ ì¶”ì¶œ
  const comboSet = new Set();
  const receivers = new Set();

  data.forEach(row => {
    comboSet.add(`${row["í†µì‹ ë°©ì‹"]} | ${row["êµ¬ë¶„"]}`);
    receivers.add(row["ë°›ëŠ”ì‚¬ëŒ"]);
  });

  const combos = Array.from(comboSet).sort((a, b) => {
  const [typeA, catA] = a.split(" | ");
  const [typeB, catB] = b.split(" | ");
  return typeA.localeCompare(typeB, "ko") || catA.localeCompare(catB, "ko");
  });
  const receiverList = Array.from(receivers).sort((a, b) => a.localeCompare(b, "ko"));

  // âœ… í”¼ë²— í…Œì´ë¸” ìƒì„±
  const pivot = {};
  combos.forEach(c => pivot[c] = {});

  data.forEach(row => {
    const key = `${row["í†µì‹ ë°©ì‹"]} | ${row["êµ¬ë¶„"]}`;
    const recv = row["ë°›ëŠ”ì‚¬ëŒ"];
    const qty = Number(row["ìˆ˜ëŸ‰"]) || 0;
    pivot[key][recv] = (pivot[key][recv] || 0) + qty;
  });

  // âœ… í…Œì´ë¸” HTML ìƒì„±
  let html = "<table class='w-full border text-center border-gray-300'>";
  html += "<thead class='bg-blue-100'>";
  html += "<tr><th class='border p-2'>í†µì‹ ë°©ì‹</th><th class='border p-2'>êµ¬ë¶„</th><th class='border p-2'>í•©ê³„</th>";
  receiverList.forEach(r => html += `<th class='border p-2'>${r}</th>`);
  html += "</tr></thead><tbody>";

  combos.forEach(c => {
    const [type, category] = c.split(" | ");

    // âœ… í•©ê³„ ê³„ì‚°
    const total = receiverList.reduce((sum, r) => sum + (pivot[c][r] || 0), 0);

    html += `<tr>
               <td class='border p-2'>${type}</td>
               <td class='border p-2'>${category}</td>
               <td class='border p-2 font-semibold bg-gray-50'>${total}</td>`;
    receiverList.forEach(r => {
      html += `<td class='border p-2'>${pivot[c][r] || ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

window.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>

