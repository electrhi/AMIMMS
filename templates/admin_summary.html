<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📊 관리자 종합관리표</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- ✅ 스타일은 <head> 안으로 이동 -->
<style>
  /* ✅ 표 스타일 개선 */
  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 1000px; /* 너무 좁아지지 않게 최소폭 지정 */
    table-layout: auto;
    font-size: 0.85rem;  /* 글자 약간 줄이기 */
    white-space: nowrap; /* 글자 줄바꿈 방지 → 가로 스크롤 허용 */
  }

  th, td {
    padding: 6px 10px;
    text-align: center;
    border: 1px solid #ccc;
  }

  thead th {
    position: sticky;   /* ✅ 머리글 고정 */
    top: 0;
    background-color: #e8f0fe;
    z-index: 1;
  }

  /* ✅ 행 hover 효과 */
  tbody tr:hover {
    background-color: #f9f9f9;
  }

  /* ✅ 긴 이름일 때 자동 줄이기 */
  td {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
  <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">
    📊 종합관리표 (클라이언트 렌더링)
  </h2>

  <!-- ✅ 표 컨테이너 -->
  <div id="table-container" 
       class="overflow-x-auto max-w-full mt-4 border border-gray-200 rounded-lg shadow-inner"></div>

  <div class="flex justify-center mt-8">
    <a href="{{ url_for('menu') }}" 
       class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">⬅ 메뉴로</a>
  </div>
</div>

<script>
async function loadData() {
  const container = document.getElementById("table-container");

  const res = await fetch("/api/admin_data");
  const json = await res.json();

  if (!json.data || json.data.length === 0) {
    container.innerHTML = "<p class='text-center text-red-600 font-semibold mt-4'>❌ 데이터가 없습니다.</p>";
    return;
  }

  const data = json.data;

  // ✅ 고유 조합 및 받는사람 목록 추출
  const comboSet = new Set();
  const receivers = new Set();

  data.forEach(row => {
    comboSet.add(`${row["통신방식"]} | ${row["구분"]}`);
    receivers.add(row["받는사람"]);
  });

  const combos = Array.from(comboSet).sort((a, b) => {
  const [typeA, catA] = a.split(" | ");
  const [typeB, catB] = b.split(" | ");
  return typeA.localeCompare(typeB, "ko") || catA.localeCompare(catB, "ko");
  });
  const receiverList = Array.from(receivers).sort((a, b) => a.localeCompare(b, "ko"));

  // ✅ 피벗 테이블 생성
  const pivot = {};
  combos.forEach(c => pivot[c] = {});

  data.forEach(row => {
    const key = `${row["통신방식"]} | ${row["구분"]}`;
    const recv = row["받는사람"];
    const qty = Number(row["수량"]) || 0;
    pivot[key][recv] = (pivot[key][recv] || 0) + qty;
  });

  // ✅ 테이블 HTML 생성
  let html = "<table class='w-full border text-center border-gray-300'>";
  html += "<thead class='bg-blue-100'>";
  html += "<tr><th class='border p-2'>통신방식</th><th class='border p-2'>구분</th><th class='border p-2'>합계</th>";
  receiverList.forEach(r => html += `<th class='border p-2'>${r}</th>`);
  html += "</tr></thead><tbody>";

  combos.forEach(c => {
    const [type, category] = c.split(" | ");

    // ✅ 합계 계산
    const total = receiverList.reduce((sum, r) => sum + (pivot[c][r] || 0), 0);

    html += `<tr>
               <td class='border p-2'>${type}</td>
               <td class='border p-2'>${category}</td>
               <td class='border p-2 font-semibold bg-gray-50'>${total}</td>`;
    receiverList.forEach(r => {
      html += `<td class='border p-2'>${pivot[c][r] || ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

window.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>

